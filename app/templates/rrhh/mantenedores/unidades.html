{% extends "base.html" %}

{% block title %}Unidades y Departamentos - NEXU-MUNI{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-10">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

        <h1 class="text-2xl font-bold text-gray-900 mb-6">Estructura Organizacional</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if category=='error' %}bg-red-50 text-red-700{% else %}bg-green-50 text-green-700{% endif %} flex justify-between">
                    {{ message }}
                    <span class="cursor-pointer" onclick="this.parentElement.remove()">&times;</span>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-fit lg:col-span-1">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="font-bold text-gray-800" id="titulo-form">Nueva Unidad</h3>
                    <button id="btn-cancelar" onclick="cancelarEdicion()" class="hidden text-xs text-red-500 font-bold hover:underline">Cancelar</button>
                </div>
                
                <form id="form-unidad" action="{{ url_for('rrhh.mantenedor_unidades') }}" method="POST">
                    <div class="space-y-4">
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Nombre Unidad</label>
                            <input type="text" id="input_nombre" name="nombre" class="w-full border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: DIDECO" required>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Sigla / Código</label>
                                <input type="text" id="input_codigo" name="codigo" class="w-full border-gray-300 rounded-lg text-sm uppercase" placeholder="Ej: 2101">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Tipo</label>
                                <select id="input_tipo" name="tipo" class="w-full border-gray-300 rounded-lg text-sm bg-white" required>
                                    <option value="DIRECCION">Dirección</option>
                                    <option value="DEPARTAMENTO">Departamento</option>
                                    <option value="OFICINA">Oficina / Unidad</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Depende de (Padre)</label>
                            <select id="input_padre" name="padre_id" class="w-full border-gray-300 rounded-lg text-sm bg-white">
                                <option value="">-- Es Unidad Superior --</option>
                                {% for u in unidades %}
                                    {% if u.tipo == 'DIRECCION' or u.tipo == 'DEPARTAMENTO' %}
                                    <option value="{{ u.id }}">{{ u.nombre }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <p class="text-[10px] text-gray-400 mt-1">Si es Dirección, déjelo en blanco.</p>
                        </div>

                        <button id="btn-guardar" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-bold hover:bg-blue-700 shadow transition">
                            Guardar Unidad
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden lg:col-span-2">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Nombre / Sigla</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Dependencia</th>
                            <th class="px-6 py-3 text-right"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for u in unidades %}
                        <tr class="hover:bg-blue-50 transition group">
                            <td class="px-6 py-4">
                                <div class="text-sm font-bold text-gray-900">{{ u.nombre }}</div>
                                <div class="text-xs text-gray-400 font-mono">{{ u.sigla or 'S/C' }}</div>
                            </td>
                            <td class="px-6 py-4">
                                {% if u.tipo == 'DIRECCION' %}
                                    <span class="px-2 py-1 bg-purple-100 text-purple-800 text-[10px] font-bold rounded">DIRECCIÓN</span>
                                {% elif u.tipo == 'DEPARTAMENTO' %}
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-[10px] font-bold rounded">DEPTO</span>
                                {% else %}
                                    <span class="px-2 py-1 bg-gray-100 text-gray-800 text-[10px] font-bold rounded">OFICINA</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-xs text-gray-500">
                                {% if u.unidad_padre %}
                                    {{ u.unidad_padre.nombre }}
                                {% else %}
                                    <span class="text-gray-300 italic">-- Superior --</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-right text-sm font-medium">
                                <button onclick="editarUnidad(
                                    '{{ u.id }}',
                                    '{{ u.nombre }}',
                                    '{{ u.sigla or '' }}',
                                    '{{ u.tipo }}',
                                    '{{ u.padre_id or '' }}'
                                )" class="text-blue-600 hover:text-blue-900 mr-3 font-bold">Editar</button>
                                
                                <a href="{{ url_for('rrhh.eliminar_unidad', id=u.id) }}" onclick="return confirm('¿Seguro? Si tiene dependencias no se borrará.')" class="text-red-400 hover:text-red-600 font-bold opacity-0 group-hover:opacity-100">&times;</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="px-6 py-10 text-center text-gray-400">No hay unidades registradas.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function editarUnidad(id, nombre, codigo, tipo, padre_id) {
        // Visual
        document.getElementById('titulo-form').innerText = 'Editar Unidad';
        document.getElementById('btn-guardar').innerText = 'Actualizar';
        document.getElementById('btn-guardar').classList.replace('bg-blue-600', 'bg-gray-800');
        document.getElementById('btn-cancelar').classList.remove('hidden');

        // Acción del Form
        const form = document.getElementById('form-unidad');
        form.action = "/rrhh/mantenedores/unidades/editar/" + id;

        // Datos
        document.getElementById('input_nombre').value = nombre;
        document.getElementById('input_codigo').value = codigo;
        document.getElementById('input_tipo').value = tipo;
        document.getElementById('input_padre').value = padre_id;

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelarEdicion() {
        document.getElementById('titulo-form').innerText = 'Nueva Unidad';
        document.getElementById('btn-guardar').innerText = 'Guardar Unidad';
        document.getElementById('btn-guardar').classList.replace('bg-gray-800', 'bg-blue-600');
        document.getElementById('btn-cancelar').classList.add('hidden');

        const form = document.getElementById('form-unidad');
        form.action = "{{ url_for('rrhh.mantenedor_unidades') }}";
        form.reset();
    }
</script>
{% endblock %}